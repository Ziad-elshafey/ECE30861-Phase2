name: CI/CD Pipeline

on: [push, pull_request]

jobs:
  # Existing CI Job
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      DATABASE_URL: sqlite:///./test.db
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

    - name: Run MyPy
      run: mypy src --ignore-missing-imports
      continue-on-error: true

    - name: Run tests
      run: |
        python -m pytest --cov=src --cov-report=term-missing tests/

  # New CD Job - Deploy to AWS
  cd:
    name: Continuous Deployment
    needs: ci
    runs-on: ubuntu-latest
    # Only deploy on push to main branch (not on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "Building Docker image..."
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        echo "Pushing to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        echo "‚úÖ Image pushed successfully!"
        echo "Image URI: $ECR_REGISTRY/$ECR_REPOSITORY:latest"

    - name: Deployment summary
      run: |
        echo "üöÄ Deployment Summary"
        echo "===================="
        echo "‚úÖ Docker image built and pushed to ECR"
        echo "‚úÖ Image tag: ${{ github.sha }}"
        echo "‚úÖ Latest tag updated"
        echo ""
        echo "üì¶ Next: AWS App Runner will automatically pull and deploy"
        echo "üåê Your API will be available at the App Runner URL"
